name: iOS Build - Generate IPA

on:
  push:
    branches: [main]
    paths:
      - 'ios/**'
  workflow_dispatch:

jobs:
  build-unsigned-ipa:
    name: ðŸ”¨ Build Unsigned IPA
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.0.app

      - name: Show build info
        run: |
          xcodebuild -version
          echo "Building Radarapp iOS..."

      - name: Build for iOS Device (unsigned)
        working-directory: ios
        run: |
          xcodebuild clean build \
            -project Radarapp.xcodeproj \
            -scheme Radarapp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Create unsigned IPA
        working-directory: ios
        run: |
          # Find the .app
          APP_PATH=$(find build -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          
          # Create Payload folder and IPA
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r Radarapp-unsigned.ipa Payload
          rm -rf Payload
          
          echo "âœ… IPA created: Radarapp-unsigned.ipa"
          ls -la Radarapp-unsigned.ipa

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Radarapp-unsigned-IPA
          path: ios/Radarapp-unsigned.ipa
          retention-days: 30

      - name: Build Summary
        run: |
          echo "## ðŸ“± Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download your IPA:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Click this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Download **Radarapp-unsigned-IPA** artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### To install on iPhone:" >> $GITHUB_STEP_SUMMARY
          echo "- Use **AltStore** or **Sideloadly** (free, re-sign every 7 days)" >> $GITHUB_STEP_SUMMARY
          echo "- Or get Apple Developer account (99â‚¬/year) for permanent install" >> $GITHUB_STEP_SUMMARY
